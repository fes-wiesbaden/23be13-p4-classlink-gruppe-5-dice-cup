<!-- Von Lukas bearbeitet; Template dem Student-Layout angeglichen -->
<p-toast></p-toast>
<div class="teacher-page">
  <section class="card header-card">
    <div class="identity">
      <div class="avatar">{{ teacherName | slice: 0 : 1 }}</div>
      <div>
        <h1 class="teacher-heading">{{ teacherName }}</h1>
        <div class="chips-row">
          <span class="chip chip--soft" *ngIf="teacherSubject">{{ teacherSubject }}</span>
          <span class="chip chip--outline" *ngIf="teacherRole">{{ teacherRole }}</span>
        </div>
      </div>
    </div>

    <div class="dicecup-logo">
      <div class="dicecup__logo" role="img" aria-label="DiceCup">
        <img class="dicecup-logo-icon" src="/assets/DiceCupLogoFinal.svg" alt="DiceCup" />
      </div>
    </div>
  </section>

  <teacher-student-sidebar
    [students]="filteredStudents"
    [selectedStudentId]="selectedStudentId"
    [search]="search"
    [classes]="classes"
    [selectedClass]="selectedClass"
    [assignClassName]="assignClassName"
    (selectStudent)="onSelectStudent($event)"
    (searchChange)="onSearchChange($event)"
    (classChange)="onClassChange($event)"
    (createClass)="onCreateClass()"
    (assignClassChange)="assignClassName = $event"
    (assignSelected)="onAssignSelectedToClass()"
  />

  <main class="content" *ngIf="selectedStudent as st">
    <div class="main-grid">
      <div class="grade-column">
        <section class="card grades-card" *ngIf="lernfelder.length">
          <div class="section-header">
            <h2>Lernfelder &amp; Noten</h2>
            <button type="button" class="chip chip--soft subject-btn" (click)="openSubjectDialog()">
              Fach hinzufügen
            </button>
          </div>

          <div class="grade-grid">
            <button
              class="grade-card"
              type="button"
              *ngFor="let lf of lernfelder; trackBy: trackByLernfeld"
              (click)="selectLernfeld(lf)"
              [class.grade-card--active]="isLernfeldSelected(lf.id)"
            >
              <div class="grade-card__top">
                <span class="pill">LF {{ lf.id }}</span>
              </div>
              <div class="grade-card__title">{{ lf.focus }}</div>
              <div class="grade-card__meta">
                <div class="grade-card__value">{{ lf.average | number: '1.1-1' }}</div>
                <span class="label">Note</span>
              </div>
              <div class="bar">
                <span class="fill" [style.width.%]="gradeProgress(lf.average)"></span>
              </div>
            </button>
          </div>

          <div class="summary-row" *ngIf="lernfelder.length">
            <div class="mini-card">
              <p class="mini-label">Gesamtschnitt</p>
              <p class="mini-value">{{ overallAverage || '-' }}</p>
            </div>
            <div class="mini-card">
              <p class="mini-label">Aktive Projekte</p>
              <p class="mini-value">{{ runningProjects }}</p>
            </div>
          </div>
        </section>
      </div>

      <section class="card projects-card">
        <teacher-project-assignment
          class="assign modern"
          [projectName]="currentProjectName || ''"
          [students]="students"
          [assignedIds]="assignedIds"
          [projectOptions]="projectOptions"
          [projectId]="selectedProjectId"
          (projectChange)="onProjectChange($any($event))"
          (studentToggle)="onToggleAssignment($event)"
          (createProject)="onCreateProject()"
        />
      </section>
    </div>
  </main>
</div>

<p-dialog
  header="Neues Fach hinzufügen"
  [(visible)]="showSubjectDialog"
  [modal]="true"
  [draggable]="false"
  [dismissableMask]="true"
  [style]="{ width: '420px' }"
>
  <div class="subject-dialog">
    <label class="field-label" for="subjectName">Name</label>
    <input
      id="subjectName"
      pInputText
      type="text"
      [(ngModel)]="subjectName"
      placeholder="z.B. Datenbanken"
    />

    <label class="field-label" for="subjectDescription">Beschreibung</label>
    <textarea
      id="subjectDescription"
      [(ngModel)]="subjectDescription"
      rows="3"
      placeholder="Kurzbeschreibung des Fachs"
    ></textarea>

    <div class="dialog-actions">
      <button type="button" class="btn ghost" (click)="closeSubjectDialog()">Abbrechen</button>
      <button
        type="button"
        class="btn"
        (click)="saveSubject()"
        [disabled]="!subjectName.trim() || !subjectDescription.trim()"
      >
        Speichern
      </button>
    </div>
  </div>
</p-dialog>
